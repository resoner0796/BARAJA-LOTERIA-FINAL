<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Loter√≠a Mexicana Master</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    /* --- VARIABLES PRO --- */
    :root {
      --primary-gradient: linear-gradient(135deg, #ff4b1f 0%, #ff9068 100%);
      --glass-bg: rgba(20, 20, 20, 0.95);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --gold-glow: 0 0 35px rgba(255, 215, 0, 0.6);
    }

    body {
      margin: 0; font-family: 'Poppins', sans-serif;
      background: url('fondo.jpg') no-repeat center center fixed; background-size: cover;
      color: #fff; height: 100vh; overflow-y: auto; display: flex; flex-direction: column;
    }

    /* --- PANTALLA DE CONEXI√ìN (SETUP) --- */
    #setup-screen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(10, 10, 10, 0.98); z-index: 10000;
      display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;
      text-align: center;
    }
    .setup-box { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #333; max-width: 90%; width: 300px; box-shadow: 0 10px 30px black; }
    .setup-box h3 { margin-top: 0; color: #ffd700; }
    
    input { 
      padding: 12px; font-size: 1.2rem; text-align: center; border-radius: 10px; border: 1px solid #555; 
      background: #333; color: white; margin-top: 10px; width: 80%; text-transform: uppercase; font-weight: bold; letter-spacing: 2px;
    }
    
    /* --- MODO TV (VISOR) - CORREGIDO PARA QUE NO SE ENCIME --- */
    body.tv-mode header, body.tv-mode .bottom-panel { display: none !important; }
    
    body.tv-mode { 
      background: #000; 
      padding: 20px; 
      box-sizing: border-box; 
      display: flex; 
      flex-direction: column; /* Apilar verticalmente */
      justify-content: flex-end; 
      overflow: hidden; 
      height: 100vh;
    }
    
    /* √Årea principal de la carta en TV */
    body.tv-mode #main-content { 
      flex: 1; /* Ocupa todo el espacio libre disponible */
      display: flex; 
      justify-content: center; 
      align-items: center; 
      width: 100%; 
      min-height: 0; /* IMPORTANTE: Permite que el contenedor se encoja si falta espacio */
      margin-bottom: 20px; /* Separaci√≥n forzosa con el historial */
    }

    body.tv-mode #cartaActual {
        height: 100%;
        width: 100%;
        align-items: center;
    }

    body.tv-mode #cartaActual img { 
      height: auto; 
      max-height: 100%; /* Nunca m√°s alto que su contenedor */
      max-width: 95vw; 
      width: auto; 
      border: 8px solid #ffd700; 
      box-shadow: 0 0 60px rgba(255, 215, 0, 0.6); 
      object-fit: contain; /* Asegura que la imagen completa se vea */
    }

    /* Historial TV */
    body.tv-mode #historial-tv {
      flex: 0 0 130px; /* Altura fija reservada para el historial */
      width: 100%; 
      background: rgba(255,255,255,0.1);
      border-radius: 15px; 
      display: flex !important;
      align-items: center; 
      padding: 0 10px; 
      gap: 10px; 
      overflow-x: hidden;
      border: 1px solid rgba(255,255,255,0.1); 
    }

    body.tv-mode #historial-tv img { 
      height: 80%; 
      border-radius: 8px; 
      opacity: 0.6; 
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    body.tv-mode #historial-tv img:first-child { 
      opacity: 1; 
      border: 2px solid #ffd700; 
      transform: scale(1.05); 
      margin-right: 15px; 
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }

    /* --- UI CELULAR (CONTROL) --- */
    header { padding: 10px; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    h1 { margin: 5px 0 10px 0; font-size: 1.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; 
         background: linear-gradient(to right, #ffffff, #dcdcdc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    #historial { display: flex; overflow-x: auto; gap: 8px; height: 70px; padding: 5px 10px; align-items: center; }
    #historial img { height: 60px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
    #historial-tv { display: none; } /* Oculto en el cel */

    /* Main Content */
    #main-content { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; width: 100%; min-height: 400px; }
    #cartaActual { display: flex; justify-content: center; width: 100%; height: 350px; } /* Altura fija para no saltar en Celular */
    #cartaActual img { 
      height: 320px; max-width: 90%; border: 6px solid #ffd700; border-radius: 18px; 
      box-shadow: var(--gold-glow); animation: dealCard 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    
    @keyframes dealCard { 0% { opacity: 0; transform: scale(0.5) translateY(-50px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

    /* --- BOTTOM PANEL (CONTROLES PRO) --- */
    .bottom-panel { 
      background: var(--glass-bg); padding: 20px; border-radius: 25px 25px 0 0; 
      border-top: var(--glass-border); box-shadow: 0 -10px 40px rgba(0,0,0,0.7); 
    }

    /* Barra de Estado (Contadores + Selector) */
    .status-bar { 
      display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); 
      padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); 
    }
    .counters span { color: #ffd700; font-weight: 800; font-size: 1.1rem; }
    
    /* Selector Estilizado */
    .speed-control select {
      background: #333; color: white; border: 1px solid #555; padding: 8px 12px; border-radius: 8px;
      font-family: 'Poppins', sans-serif; font-size: 0.9rem; outline: none; cursor: pointer;
    }

    /* Grid de Botones */
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { 
      padding: 14px; border-radius: 10px; border: none; font-weight: 700; color: white; cursor: pointer; 
      font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; transition: transform 0.1s;
      display: flex; justify-content: center; align-items: center; gap: 8px; font-family: 'Poppins', sans-serif;
    }
    .btn:active { transform: scale(0.97); }
    .btn-large { grid-column: span 2; font-size: 1.1rem; }

    /* Colores Pro */
    .btn-shuffle { background: #3f51b5; box-shadow: 0 4px 0 #283593; }
    .btn-start { background: #009688; box-shadow: 0 4px 0 #00695c; }
    .btn-next { background: linear-gradient(to right, #ff416c, #ff4b2b); box-shadow: 0 4px 0 #b71c1c; }
    .btn-stop { background: #444; box-shadow: 0 4px 0 #222; border: 1px solid #666; }

    /* Mensaje Loter√≠a */
    #loteriaTexto { 
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      font-size: 5rem; font-weight: 900; background: linear-gradient(to bottom, #ffd700, #ff8c00); 
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: none; z-index: 2000; 
      text-shadow: 0 10px 40px black; 
    }

    /* --- SOPORTE PARA CONTROL REMOTO (ANDROID TV) --- */
    
    /* Cuando un bot√≥n o input recibe el "foco" del control remoto */
    .btn:focus, input:focus, select:focus {
      outline: 4px solid #ffffff; /* Borde blanco grueso */
      box-shadow: 0 0 30px #ffd700; /* Resplandor dorado */
      transform: scale(1.1); /* Se hace m√°s grande */
      z-index: 50;
      background: linear-gradient(to right, #ff416c, #ff4b2b) !important; /* Color destacado */
    }

    /* Ajuste para que el input del c√≥digo se note m√°s */
    input:focus {
      background: #fff;
      color: #000;
    }
    
  </style>
</head>
<body>

<div id="setup-screen">
  <h1 style="color: white; margin-bottom: 20px;">üé¥ LOTER√çA CONNECT</h1>
  
  <div class="setup-box">
    <h3>üì∫ MODO PANTALLA</h3>
    <button class="btn" style="background: linear-gradient(to right, #8e2de2, #4a00e0); width:100%;" onclick="iniciarComoTV()">
      Crear Sala
    </button>
    <div id="tv-code-display" style="margin-top:15px; display:none;">
      <p style="color:#aaa;">C√ìDIGO DE SALA:</p>
      <h1 id="room-code" style="color:#ffd700; font-size:3rem; letter-spacing:5px; margin: 10px 0;">...</h1>
    </div>
  </div>

  <div style="color: #666;">- O -</div>

  <div class="setup-box">
    <h3>üì± MODO CONTROL</h3>
    <input type="text" id="input-code" placeholder="C√ìDIGO" maxlength="4">
    <button class="btn" style="background: linear-gradient(to right, #11998e, #38ef7d); width:100%; margin-top:15px;" onclick="iniciarComoHost()">
      Conectar
    </button>
  </div>
</div>

<header>
  <h1>üé¥ LOTER√çA MEXICANA</h1>
  <div id="historial"></div>
</header>

<div id="main-content">
  <div id="loteriaTexto">¬°LOTER√çA!</div>
  <div id="cartaActual"></div>
</div>

<div id="historial-tv"></div>

<div class="bottom-panel">
  <div class="status-bar">
    <div class="counters">
      <span>üÉè <span id="cartasContadas">0</span>/54</span>
    </div>
    <div class="speed-control">
      <select id="intervalo" onchange="actualizarIntervalo()">
        <option value="2000">üöÄ R√°pido (2s)</option>
        <option value="3000">üêá Normal (3s)</option>
        <option value="4000" selected>üê¢ Tranqui (4s)</option>
        <option value="5000">üêå Lento (5s)</option>
        <option value="6000">‚òï Muy Lento (6s)</option>
      </select>
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-shuffle" onclick="barajear()">üé≤ Barajear</button>
    <button class="btn btn-start" onclick="iniciarJuego()">üîî Iniciar</button>
    <button class="btn btn-next btn-large" onclick="mostrarSiguiente()">‚è≠Ô∏è Siguiente Carta</button>
    <button class="btn btn-stop btn-large" onclick="detenerJuego()">‚úã Detener Juego</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* --- L√ìGICA DE CONEXI√ìN P2P (PEERJS) --- */
let peer = null;
let conn = null;
let isTV = false;

function generarID() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let result = "";
  for(let i=0; i<4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
  return "LOTERIA-" + result;
}

// INICIAR COMO TV
function iniciarComoTV() {
  const myID = generarID();
  const displayCode = myID.split('-')[1];
  
  document.getElementById('tv-code-display').style.display = 'block';
  document.getElementById('room-code').innerText = displayCode;
  
  peer = new Peer(myID);
  
  peer.on('open', (id) => console.log('TV Lista:', id));
  peer.on('connection', (connection) => {
    conn = connection;
    conn.on('open', () => {
      document.getElementById('setup-screen').style.display = 'none';
      document.body.classList.add('tv-mode');
    });
    conn.on('data', (data) => manejarDatosTV(data));
  });
  isTV = true;
}

// INICIAR COMO CONTROL
function iniciarComoHost() {
  const codeInput = document.getElementById('input-code').value.toUpperCase().trim();
  if(codeInput.length < 4) return alert("Ingresa el c√≥digo de 4 letras");
  
  const targetID = "LOTERIA-" + codeInput;
  peer = new Peer();
  
  peer.on('open', (id) => {
    conn = peer.connect(targetID);
    conn.on('open', () => {
      document.getElementById('setup-screen').style.display = 'none';
      barajear(); // Resetear al entrar
    });
    conn.on('error', (err) => alert("Error: No se encuentra la TV"));
  });
}

function manejarDatosTV(data) {
  if (data.accion === 'mostrar') renderizarCartaTV(data.numero);
  else if (data.accion === 'barajear') { limpiarTV(); reproducirSonido("barajar.mp3"); }
  else if (data.accion === 'loteria') mostrarLoteriaTV();
}

/* --- L√ìGICA DE JUEGO --- */
let barajas = Array.from({ length: 54 }, (_, i) => i + 1);
let mezcladas = [];
let index = 0;
let intervalo = null;
let tiempo = 4000;

function actualizarIntervalo() {
  tiempo = parseInt(document.getElementById("intervalo").value);
  if(intervalo) { clearInterval(intervalo); intervalo = setInterval(mostrarSiguiente, tiempo); }
}

function reproducirSonido(nombreArchivo) {
  new Audio(nombreArchivo).play().catch(e => {});
}

function barajear() {
  if(isTV) return;
  mezcladas = [...barajas].sort(() => Math.random() - 0.5);
  index = 0;
  
  limpiarHost();
  if(conn) conn.send({ accion: 'barajear' });
  
  reproducirSonido("barajar.mp3");
  document.getElementById("cartasContadas").textContent = "0";
}

function limpiarHost() {
  document.getElementById("cartaActual").innerHTML = "";
  document.getElementById("historial").innerHTML = "";
  document.getElementById("loteriaTexto").style.display = "none";
  detenerJuegoSilencioso();
}

function limpiarTV() {
  document.getElementById("cartaActual").innerHTML = "";
  document.getElementById("historial-tv").innerHTML = "";
  document.getElementById("loteriaTexto").style.display = "none";
}

function detenerJuegoSilencioso() {
  clearInterval(intervalo);
  intervalo = null;
}

function iniciarJuego() {
  if (!mezcladas.length) barajear();
  if (intervalo) return;
  
  reproducirSonido("campana.mp3");
  reproducirSonido("corre.mp3");
  intervalo = setInterval(mostrarSiguiente, tiempo);
}

function mostrarSiguiente() {
  if (index < mezcladas.length) {
    const numero = mezcladas[index];
    index++;
    
    renderizarCartaHost(numero);
    if(conn) conn.send({ accion: 'mostrar', numero: numero });
    
    document.getElementById("cartasContadas").textContent = index;
  } else {
    detenerJuego();
  }
}

function detenerJuego() {
  clearInterval(intervalo);
  intervalo = null;
  mostrarLoteriaHost();
  if(conn) conn.send({ accion: 'loteria' });
}

// RENDER CONTROL
function renderizarCartaHost(numero) {
  const nombre = String(numero).padStart(2, '0');
  const imagen = `img/${nombre}.png`;
  const audio = `audios/${nombre}.mp3`;
  
  document.getElementById("cartaActual").innerHTML = `<img src="${imagen}">`;
  
  const hist = document.getElementById("historial");
  const imgHist = document.createElement('img');
  imgHist.src = imagen;
  hist.prepend(imgHist); // Nueva a la izquierda
  
  reproducirSonido(audio);
}

// RENDER TV
function renderizarCartaTV(numero) {
  const nombre = String(numero).padStart(2, '0');
  const imagen = `img/${nombre}.png`;
  const audio = `audios/${nombre}.mp3`;
  
  document.getElementById("cartaActual").innerHTML = `<img src="${imagen}">`;
  
  // Historial TV (NUEVA A LA IZQUIERDA)
  const histTV = document.getElementById("historial-tv");
  const imgHist = document.createElement('img');
  imgHist.src = imagen;
  histTV.prepend(imgHist);
  
  if(histTV.children.length > 10) histTV.removeChild(histTV.lastChild); // Limitar a 10
  
  reproducirSonido(audio);
}

function mostrarLoteriaHost() {
  reproducirSonido("aplausos.mp3");
  document.getElementById("loteriaTexto").style.display = "block";
  confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
}

function mostrarLoteriaTV() {
  reproducirSonido("aplausos.mp3");
  document.getElementById("loteriaTexto").style.display = "block";
  confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
}
</script>

  <script>
  // --- AUTO-FOCO PARA TV ---
  // Cuando carga la app, intentamos poner el foco en el bot√≥n de TV por si es una Tele
  window.addEventListener('load', () => {
    const btnTV = document.querySelector('.setup-box .btn'); // El bot√≥n de "Crear Sala"
    if(btnTV) btnTV.focus();
  });

  // Manejo b√°sico de teclas de TV (Enter/OK)
  document.addEventListener('keydown', (e) => {
    // A veces las TV env√≠an c√≥digos raros, pero Enter suele ser 13
    if (e.key === 'Enter') {
      const activeElement = document.activeElement;
      if (activeElement && activeElement.classList.contains('btn')) {
        activeElement.click();
      }
    }
  });
</script>
  
</body>
</html>
