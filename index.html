<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Loter√≠a Mexicana P2P</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    :root {
      --glass-bg: rgba(20, 20, 20, 0.95);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --gold-glow: 0 0 35px rgba(255, 215, 0, 0.6);
    }
    body {
      margin: 0; font-family: 'Poppins', sans-serif;
      background: url('fondo.jpg') no-repeat center center fixed; background-size: cover;
      color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
    }

    /* --- PANTALLA DE INICIO (SELECCI√ìN) --- */
    #setup-screen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.95); z-index: 10000;
      display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;
      text-align: center;
    }
    .setup-box { background: #222; padding: 30px; border-radius: 20px; border: 1px solid #444; max-width: 90%; }
    input { padding: 15px; font-size: 1.2rem; text-align: center; border-radius: 10px; border: none; margin-top: 10px; width: 200px; text-transform: uppercase; font-weight: bold; letter-spacing: 2px;}
    
    /* --- MODIFICACIONES PARA TV --- */
    body.tv-mode header, body.tv-mode .bottom-panel { display: none !important; }
    
    body.tv-mode {
      justify-content: space-between; /* Espacio entre carta y historial */
      background: #000;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Carta en TV */
    body.tv-mode #main-content {
      flex: 1; display: flex; justify-content: center; align-items: center; width: 100%;
    }
    body.tv-mode #cartaActual img {
      height: 70vh; /* Ocupa buen espacio pero deja lugar al historial */
      width: auto;
      border: 8px solid #ffd700;
      box-shadow: 0 0 60px rgba(255, 215, 0, 0.5);
    }

    /* Historial en TV (NUEVO) */
    body.tv-mode #historial-tv {
      display: flex !important; /* Forzar mostrar */
      height: 15vh;
      width: 100%;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      align-items: center;
      padding: 0 10px;
      gap: 10px;
      overflow-x: hidden; /* Ocultamos scroll para que se vea limpio, insertaremos al inicio */
      border: 1px solid rgba(255,255,255,0.2);
    }
    body.tv-mode #historial-tv img {
      height: 80%;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.5);
      opacity: 0.7;
    }
    /* La carta m√°s reciente en el historial brilla m√°s */
    body.tv-mode #historial-tv img:first-child {
      opacity: 1; border-color: #ffd700; transform: scale(1.05);
    }

    /* --- UI CELULAR (HOST) --- */
    header { padding: 10px; background: rgba(0,0,0,0.5); text-align: center; }
    h1 { margin: 0; font-size: 1.5rem; color: #fff; text-shadow: 0 2px 4px black; }
    
    #historial { display: flex; overflow-x: auto; gap: 5px; height: 60px; padding: 5px; justify-content: flex-start; }
    #historial img { height: 100%; border-radius: 4px; border: 1px solid #fff; }

    /* Ocultar historial de TV en modo Celular */
    #historial-tv { display: none; }

    main { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; width: 100%; }
    #cartaActual { display: flex; justify-content: center; width: 100%; }
    #cartaActual img { height: 300px; border: 5px solid #ffd700; border-radius: 15px; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    .bottom-panel { background: var(--glass-bg); padding: 15px; border-radius: 20px 20px 0 0; border-top: var(--glass-border); }
    .status-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: #ffd700; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { padding: 15px; border-radius: 10px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; }
    .btn-full { grid-column: span 2; font-size: 1.2rem; }
    
    #loteriaTexto { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; font-weight: 900; background: linear-gradient(to bottom, #ffd700, #ff8c00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: none; z-index: 2000; text-shadow: 0 10px 40px black;}
  </style>
</head>
<body>

<div id="setup-screen">
  <h1 style="font-size: 2.5rem; margin-bottom: 20px;">üé¥ LOTER√çA CONNECT</h1>
  
  <div class="setup-box">
    <h3>üì∫ ¬øERES LA PANTALLA?</h3>
    <button class="btn" style="background: linear-gradient(to right, #8e2de2, #4a00e0); width:100%;" onclick="iniciarComoTV()">
      Crear Sala (TV)
    </button>
    <div id="tv-code-display" style="margin-top:15px; display:none;">
      <p>Tu C√≥digo de Sala:</p>
      <h1 id="room-code" style="color:#ffd700; font-size:3rem; letter-spacing:5px;">...</h1>
      <p style="font-size:0.8rem; opacity:0.7;">Ingresa este c√≥digo en tu celular</p>
    </div>
  </div>

  <div style="margin: 20px 0; opacity: 0.5;">- O -</div>

  <div class="setup-box">
    <h3>üì± ¬øERES EL CONTROL?</h3>
    <input type="text" id="input-code" placeholder="C√ìDIGO DE TV" maxlength="4">
    <button class="btn" style="background: linear-gradient(to right, #11998e, #38ef7d); width:100%; margin-top:10px;" onclick="iniciarComoHost()">
      Conectar al TV
    </button>
  </div>
</div>

<header>
  <h1>üé¥ LOTER√çA MEXICANA</h1>
  <div id="historial"></div>
</header>

<div id="main-content">
  <div id="loteriaTexto">¬°LOTER√çA!</div>
  <div id="cartaActual"></div>
</div>

<div id="historial-tv">
  </div>

<div class="bottom-panel">
  <div class="status-bar">
    <span>üÉè <span id="cartasContadas">0</span>/54</span>
    <select id="intervalo" onchange="actualizarIntervalo()" style="background:#333; color:white; border:none; border-radius:4px;">
      <option value="2000">2s</option>
      <option value="3000">3s</option>
      <option value="4000" selected>4s</option>
      <option value="5000">5s</option>
      <option value="6000">6s</option>
    </select>
  </div>
  <div class="controls">
    <button class="btn" style="background:#3f51b5" onclick="barajear()">Barajear</button>
    <button class="btn" style="background:#009688" onclick="iniciarJuego()">Iniciar</button>
    <button class="btn btn-full" style="background:linear-gradient(to right, #ff416c, #ff4b2b)" onclick="mostrarSiguiente()">‚è≠Ô∏è SIGUIENTE</button>
    <button class="btn btn-full" style="background:#444" onclick="detenerJuego()">‚úã DETENER</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* --- L√ìGICA DE CONEXI√ìN (PEERJS) --- */
let peer = null;
let conn = null;
let isTV = false;

// Generar c√≥digo aleatorio de 4 letras
function generarID() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let result = "";
  for(let i=0; i<4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
  return "LOTERIA-" + result; // Prefijo √∫nico
}

// 1. MODO TV
function iniciarComoTV() {
  const myID = generarID();
  // Mostramos el c√≥digo limpio (sin el prefijo LOTERIA-)
  const displayCode = myID.split('-')[1];
  
  document.getElementById('tv-code-display').style.display = 'block';
  document.getElementById('room-code').innerText = displayCode;
  
  peer = new Peer(myID);
  
  peer.on('open', (id) => {
    console.log('TV lista con ID:', id);
  });

  peer.on('connection', (connection) => {
    conn = connection;
    // Cuando el celular se conecta
    conn.on('open', () => {
      document.getElementById('setup-screen').style.display = 'none'; // Quitar pantalla de carga
      document.body.classList.add('tv-mode'); // Activar modo TV
    });
    
    // Escuchar datos del celular
    conn.on('data', (data) => {
      manejarDatosTV(data);
    });
  });
  
  isTV = true;
}

// 2. MODO CELULAR (HOST)
function iniciarComoHost() {
  const codeInput = document.getElementById('input-code').value.toUpperCase().trim();
  if(codeInput.length < 4) return alert("Ingresa el c√≥digo de 4 caracteres");
  
  const targetID = "LOTERIA-" + codeInput;
  peer = new Peer(); // ID autom√°tico para el host
  
  peer.on('open', (id) => {
    conn = peer.connect(targetID);
    
    conn.on('open', () => {
      document.getElementById('setup-screen').style.display = 'none';
      alert("¬°Conectado a la TV!");
      barajear(); // Barajar autom√°ticamente al conectar
    });

    conn.on('error', (err) => alert("Error de conexi√≥n: " + err));
  });
}

// MANEJAR DATOS EN LA TV
function manejarDatosTV(data) {
  if (data.accion === 'mostrar') {
    renderizarCartaTV(data.numero);
  } else if (data.accion === 'barajear') {
    limpiarTV();
    reproducirSonido("barajar.mp3");
  } else if (data.accion === 'loteria') {
    mostrarLoteriaTV();
  }
}

/* --- L√ìGICA DEL JUEGO --- */
let barajas = Array.from({ length: 54 }, (_, i) => i + 1);
let mezcladas = [];
let index = 0;
let intervalo = null;
let tiempo = 4000;

function reproducirSonido(nombreArchivo) {
  // Reproducir en ambos dispositivos
  new Audio(nombreArchivo).play().catch(e => {});
}

function barajear() {
  if(isTV) return; // TV no controla
  mezcladas = [...barajas].sort(() => Math.random() - 0.5);
  index = 0;
  
  // Limpiar UI Host
  limpiarHost();
  
  // Mandar se√±al a TV
  if(conn) conn.send({ accion: 'barajear' });
  
  reproducirSonido("barajar.mp3");
  actualizarContador(0);
}

function limpiarHost() {
  document.getElementById("cartaActual").innerHTML = "";
  document.getElementById("historial").innerHTML = "";
  document.getElementById("loteriaTexto").style.display = "none";
}

function limpiarTV() {
  document.getElementById("cartaActual").innerHTML = "";
  document.getElementById("historial-tv").innerHTML = ""; // Limpiar historial TV
  document.getElementById("loteriaTexto").style.display = "none";
}

function iniciarJuego() {
  if (!mezcladas.length) barajear();
  reproducirSonido("campana.mp3");
  reproducirSonido("corre.mp3");
  if(intervalo) clearInterval(intervalo);
  intervalo = setInterval(mostrarSiguiente, tiempo);
}

function mostrarSiguiente() {
  if (index < mezcladas.length) {
    const numero = mezcladas[index];
    index++;
    
    // 1. Mostrar en Celular
    renderizarCartaHost(numero);
    
    // 2. Mandar a TV
    if(conn) conn.send({ accion: 'mostrar', numero: numero });
    
    actualizarContador(index);
  } else {
    detenerJuego();
  }
}

function detenerJuego() {
  clearInterval(intervalo);
  mostrarLoteriaHost();
  if(conn) conn.send({ accion: 'loteria' });
}

function actualizarIntervalo() {
  tiempo = parseInt(document.getElementById("intervalo").value);
  if(intervalo) { clearInterval(intervalo); intervalo = setInterval(mostrarSiguiente, tiempo); }
}

function actualizarContador(n) {
  document.getElementById("cartasContadas").textContent = n;
}

// RENDERIZADO CELULAR
function renderizarCartaHost(numero) {
  const nombre = String(numero).padStart(2, '0');
  const imagen = `img/${nombre}.png`;
  const audio = `audios/${nombre}.mp3`;
  
  document.getElementById("cartaActual").innerHTML = `<img src="${imagen}">`;
  
  // Historial Celular
  const hist = document.getElementById("historial");
  const imgHist = document.createElement('img');
  imgHist.src = imagen;
  hist.prepend(imgHist);
  
  reproducirSonido(audio);
}

// RENDERIZADO TV
function renderizarCartaTV(numero) {
  const nombre = String(numero).padStart(2, '0');
  const imagen = `img/${nombre}.png`;
  const audio = `audios/${nombre}.mp3`;
  
  document.getElementById("cartaActual").innerHTML = `<img src="${imagen}">`;
  
  // HISTORIAL EN TV (AQUI EST√Å LO QUE PEDISTE)
  const histTV = document.getElementById("historial-tv");
  const imgHist = document.createElement('img');
  imgHist.src = imagen;
  // Usamos prepend para que la nueva salga a la izquierda (principio)
  histTV.prepend(imgHist);
  
  // Limitar historial TV a ultimas 10 para que no sature memoria visual si quieres
  if(histTV.children.length > 10) histTV.removeChild(histTV.lastChild);

  reproducirSonido(audio);
}

function mostrarLoteriaHost() {
  reproducirSonido("aplausos.mp3");
  document.getElementById("loteriaTexto").style.display = "block";
  confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
}

function mostrarLoteriaTV() {
  reproducirSonido("aplausos.mp3");
  document.getElementById("loteriaTexto").style.display = "block";
  confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
}

</script>

</body>
</html>
